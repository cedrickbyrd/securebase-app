name: Phase 4 Component 3 - Notifications

# This workflow runs linting, unit tests, and documentation checks
# for Phase 4 Component 3 (Notifications) code.
#
# Runs on:
# - Pull requests targeting main branch
# - Pushes to main branch
# - Changes to relevant files only

on:
  pull_request:
    branches:
      - main
    paths:
      # Frontend
      - 'phase3a-portal/src/components/NotificationCenter.jsx'
      - 'phase3a-portal/src/components/NotificationSettings.jsx'
      - 'phase3a-portal/src/services/notificationService.js'
      - 'phase3a-portal/src/__tests__/NotificationCenter.test.jsx'
      # Backend
      - 'phase2-backend/functions/notification_worker.py'
      - 'phase2-backend/functions/notification_api.py'
      - 'phase2-backend/tests/test_notification_worker.py'
      # Infrastructure
      - 'landing-zone/modules/notifications/**'
      # Documentation
      - 'PHASE4_COMPONENT3_PLAN.md'
      - 'PHASE4_COMPONENT3_IMPLEMENTATION.md'
      - 'docs/notification-matrix.csv'
      # This workflow
      - '.github/workflows/phase4-component3.yml'
  push:
    branches:
      - main
    paths:
      - 'phase3a-portal/src/components/NotificationCenter.jsx'
      - 'phase3a-portal/src/components/NotificationSettings.jsx'
      - 'phase3a-portal/src/services/notificationService.js'
      - 'phase2-backend/functions/notification_worker.py'
      - 'phase2-backend/functions/notification_api.py'
      - 'landing-zone/modules/notifications/**'

permissions:
  contents: read
  pull-requests: write  # For commenting on PRs

jobs:
  # ==========================================================================
  # FRONTEND LINTING AND TESTS
  # ==========================================================================
  frontend-lint:
    name: Frontend - ESLint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'phase3a-portal/package-lock.json'

      - name: Install dependencies
        working-directory: phase3a-portal
        run: npm ci

      - name: Run ESLint on Notification components
        working-directory: phase3a-portal
        run: |
          npx eslint src/components/NotificationCenter.jsx \
                     src/components/NotificationSettings.jsx \
                     src/services/notificationService.js \
                     --format stylish

  frontend-tests:
    name: Frontend - Unit Tests (Jest/Vitest)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'phase3a-portal/package-lock.json'

      - name: Install dependencies
        working-directory: phase3a-portal
        run: npm ci

      - name: Run NotificationCenter tests
        working-directory: phase3a-portal
        run: |
          npm run test -- __tests__/NotificationCenter.test.jsx --run --reporter=verbose
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-test-results
          path: phase3a-portal/coverage/
          retention-days: 30

  # ==========================================================================
  # BACKEND LINTING AND TESTS
  # ==========================================================================
  backend-lint:
    name: Backend - Flake8
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install flake8
        run: pip install flake8

      - name: Run Flake8 on Notification functions
        working-directory: phase2-backend/functions
        run: |
          flake8 notification_worker.py \
                 notification_api.py \
                 --max-line-length=100 \
                 --ignore=E501,W503 \
                 --show-source \
                 --statistics

  backend-tests:
    name: Backend - Unit Tests (pytest)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        working-directory: phase2-backend/functions
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pytest pytest-cov pytest-mock

      - name: Run Notification worker tests
        working-directory: phase2-backend/tests
        run: |
          python -m pytest test_notification_worker.py -v --tb=short
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results
          path: phase2-backend/tests/coverage.xml
          retention-days: 30

  # ==========================================================================
  # INFRASTRUCTURE VALIDATION
  # ==========================================================================
  terraform-validate:
    name: Infrastructure - Terraform Validate
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.0'

      - name: Terraform Format Check
        working-directory: landing-zone/modules/notifications
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        working-directory: landing-zone/modules/notifications
        run: terraform init -backend=false

      - name: Terraform Validate
        working-directory: landing-zone/modules/notifications
        run: terraform validate

  # ==========================================================================
  # DOCUMENTATION CHECKS
  # ==========================================================================
  docs-check:
    name: Documentation - Validate
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required docs exist
        run: |
          echo "Checking for required documentation files..."
          
          # Check root docs
          [ -f "PHASE4_COMPONENT3_PLAN.md" ] && echo "‚úÖ PHASE4_COMPONENT3_PLAN.md" || \
            { echo "‚ùå PHASE4_COMPONENT3_PLAN.md missing"; exit 1; }
          
          [ -f "PHASE4_COMPONENT3_IMPLEMENTATION.md" ] && echo "‚úÖ PHASE4_COMPONENT3_IMPLEMENTATION.md" || \
            { echo "‚ùå PHASE4_COMPONENT3_IMPLEMENTATION.md missing"; exit 1; }
          
          # Check docs directory
          [ -f "docs/notification-matrix.csv" ] && echo "‚úÖ docs/notification-matrix.csv" || \
            { echo "‚ùå docs/notification-matrix.csv missing"; exit 1; }
          
          echo ""
          echo "‚úÖ All required documentation files exist"

      - name: Validate notification matrix CSV
        run: |
          echo "Validating notification-matrix.csv structure..."
          
          # Check header row
          header=$(head -n 1 docs/notification-matrix.csv)
          expected="role,resource,action,description"
          
          if [ "$header" = "$expected" ]; then
            echo "‚úÖ CSV header is correct"
          else
            echo "‚ùå CSV header is incorrect"
            echo "Expected: $expected"
            echo "Got: $header"
            exit 1
          fi
          
          # Count rows (excluding header)
          row_count=$(($(wc -l < docs/notification-matrix.csv) - 1))
          echo "‚úÖ Notification matrix has $row_count permission entries"

      - name: Check for TODO markers
        run: |
          echo "Checking for TODO markers in scaffold files..."
          
          # Count TODOs in key files
          todo_count=0
          
          for file in \
            "phase3a-portal/src/components/NotificationCenter.jsx" \
            "phase3a-portal/src/components/NotificationSettings.jsx" \
            "phase3a-portal/src/services/notificationService.js" \
            "phase2-backend/functions/notification_worker.py" \
            "phase2-backend/functions/notification_api.py"; do
            
            if [ -f "$file" ]; then
              count=$(grep -c "TODO:" "$file" || true)
              echo "  $file: $count TODOs"
              todo_count=$((todo_count + count))
            fi
          done
          
          echo ""
          echo "Total TODO markers: $todo_count"
          
          if [ $todo_count -gt 0 ]; then
            echo "‚úÖ Scaffold files contain TODO markers for implementation"
          else
            echo "‚ö†Ô∏è  No TODO markers found - files may be fully implemented"
          fi

  # ==========================================================================
  # SUMMARY AND REPORT
  # ==========================================================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [frontend-lint, frontend-tests, backend-lint, backend-tests, terraform-validate, docs-check]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate CI Summary
        run: |
          echo "# Phase 4 Component 3 - CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Lint | ${{ needs.frontend-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Tests | ${{ needs.frontend-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Lint | ${{ needs.backend-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Tests | ${{ needs.backend-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Validate | ${{ needs.terraform-validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docs Check | ${{ needs.docs-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Review test results and fix any failures" >> $GITHUB_STEP_SUMMARY
          echo "- Address TODO markers in scaffold files" >> $GITHUB_STEP_SUMMARY
          echo "- Update PHASE4_STATUS.md when implementation is complete" >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ü§ñ Phase 4 Component 3 CI Results\n\n' +
                    'Frontend Lint: ${{ needs.frontend-lint.result }}\n' +
                    'Frontend Tests: ${{ needs.frontend-tests.result }}\n' +
                    'Backend Lint: ${{ needs.backend-lint.result }}\n' +
                    'Backend Tests: ${{ needs.backend-tests.result }}\n' +
                    'Terraform: ${{ needs.terraform-validate.result }}\n' +
                    'Docs: ${{ needs.docs-check.result }}\n\n' +
                    'See workflow run for details.'
            })
