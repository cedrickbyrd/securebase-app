name: SecureBase Health Monitor

on:
  schedule:
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  monitor-production:
    name: Production Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Verify site availability
        id: availability_check
        run: |
          response_code=$(curl -s -o /dev/null -w "%{http_code}" https://securebase-app.netlify.app/)
          
          if [ $response_code -eq 200 ]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "Site responding with HTTP $response_code"
          else
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "Site returned unexpected HTTP $response_code"
            exit 1
          fi
      
      - name: Validate SSL configuration
        run: |
          ssl_expiry=$(echo | openssl s_client -servername securebase-app.netlify.app \
            -connect securebase-app.netlify.app:443 2>/dev/null | \
            openssl x509 -noout -enddate | cut -d= -f2)
          
          echo "SSL certificate expires: $ssl_expiry"
          
          expiry_epoch=$(date -d "$ssl_expiry" +%s)
          current_epoch=$(date +%s)
          days_until_expiry=$(( ($expiry_epoch - $current_epoch) / 86400 ))
          
          if [ $days_until_expiry -lt 30 ]; then
            echo "Warning: SSL certificate expires in $days_until_expiry days"
            exit 1
          fi
          
          echo "SSL certificate is valid for $days_until_expiry more days"
      
      - name: Test critical endpoints
        run: |
          echo "Testing primary application endpoint..."
          curl -f -s https://securebase-app.netlify.app/ > /dev/null
          
          if [ $? -eq 0 ]; then
            echo "Application endpoint responding correctly"
          else
            echo "Application endpoint failed health check"
            exit 1
          fi
      
      - name: Create incident report
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const incidentReport = `## SecureBase Production Health Alert\n\n` +
              `The automated health monitoring system has detected an issue with ` +
              `the production deployment at https://securebase-app.netlify.app/\n\n` +
              `**Timestamp:** ${new Date().toISOString()}\n` +
              `**Workflow:** ${context.workflow}\n` +
              `**Run ID:** ${context.runId}\n\n` +
              `Immediate investigation is required.`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[ALERT] SecureBase Production Health Check Failed - ${new Date().toISOString().split('T')[0]}`,
              body: incidentReport,
              labels: ['production', 'incident', 'health-check']
            });
