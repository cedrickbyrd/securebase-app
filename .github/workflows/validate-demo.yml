name: Validate Demo Environment

on:
  # Run after Netlify deployment
  workflow_run:
    workflows: ["Deploy to Netlify"]
    types:
      - completed

  # Manual trigger
  workflow_dispatch:

  # Daily health check at 9 AM UTC
  schedule:
    - cron: '0 9 * * *'

jobs:
  validate-demo:
    name: Validate demo.securebase.io
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for deployment
        run: sleep 10
        if: github.event_name == 'workflow_run'

      - name: Check site accessibility
        run: |
          echo "ðŸ” Checking demo site accessibility..."

          # Check HTTP 200 response
          response_code=$(curl -s -o /dev/null -w "%{http_code}" https://demo.securebase.io/)
          if [ "$response_code" -eq 200 ]; then
            echo "âœ… Site is accessible (HTTP $response_code)"
          else
            echo "âŒ Site returned HTTP $response_code"
            exit 1
          fi

          # Check HTTPS redirect
          http_redirect=$(curl -s -o /dev/null -w "%{http_code}" http://demo.securebase.io/)
          if [ "$http_redirect" -eq 301 ] || [ "$http_redirect" -eq 308 ]; then
            echo "âœ… HTTP â†’ HTTPS redirect works (HTTP $http_redirect)"
          else
            echo "âš ï¸ HTTP redirect returned $http_redirect (expected 301 or 308)"
          fi

      - name: Validate security headers
        run: |
          echo "ðŸ”’ Validating security headers..."

          headers=$(curl -sI https://demo.securebase.io/)

          # Check Content-Security-Policy
          if echo "$headers" | grep -qi "Content-Security-Policy"; then
            echo "âœ… Content-Security-Policy present"
          else
            echo "âŒ Missing Content-Security-Policy"
            exit 1
          fi

          # Check X-Frame-Options
          if echo "$headers" | grep -qi "X-Frame-Options.*DENY"; then
            echo "âœ… X-Frame-Options: DENY"
          else
            echo "âŒ Missing or incorrect X-Frame-Options"
            exit 1
          fi

          # Check X-Content-Type-Options
          if echo "$headers" | grep -qi "X-Content-Type-Options.*nosniff"; then
            echo "âœ… X-Content-Type-Options: nosniff"
          else
            echo "âŒ Missing X-Content-Type-Options"
            exit 1
          fi

          # Check Strict-Transport-Security
          if echo "$headers" | grep -qi "Strict-Transport-Security"; then
            echo "âœ… Strict-Transport-Security present"
          else
            echo "âŒ Missing Strict-Transport-Security (HSTS)"
            exit 1
          fi

          # Check X-Environment: demo
          if echo "$headers" | grep -qi "X-Environment.*demo"; then
            echo "âœ… X-Environment: demo"
          else
            echo "âš ï¸ Missing X-Environment: demo header"
          fi

          # Check X-Robots-Tag
          if echo "$headers" | grep -qi "X-Robots-Tag.*noindex"; then
            echo "âœ… X-Robots-Tag: noindex"
          else
            echo "âš ï¸ Missing X-Robots-Tag: noindex"
          fi

          # Check Referrer-Policy
          if echo "$headers" | grep -qi "Referrer-Policy"; then
            echo "âœ… Referrer-Policy present"
          else
            echo "âš ï¸ Missing Referrer-Policy"
          fi

          # Check Permissions-Policy
          if echo "$headers" | grep -qi "Permissions-Policy"; then
            echo "âœ… Permissions-Policy present"
          else
            echo "âš ï¸ Missing Permissions-Policy"
          fi

      - name: Check security.txt
        run: |
          echo "ðŸ“„ Checking security.txt file..."

          response=$(curl -s https://demo.securebase.io/.well-known/security.txt)

          if [ -z "$response" ]; then
            echo "âŒ security.txt file not found"
            exit 1
          fi

          # Check for contact info
          if echo "$response" | grep -qi "Contact:"; then
            echo "âœ… Contact information present"
          else
            echo "âŒ Missing contact information"
            exit 1
          fi

          # Check for expiry
          if echo "$response" | grep -qi "Expires:"; then
            echo "âœ… Expiry date present"

            # Extract expiry date and check if expired
            expiry_line=$(echo "$response" | grep -i "Expires:" | head -n 1)
            expiry_date=$(echo "$expiry_line" | sed 's/Expires: //' | tr -d '\r')

            # Convert to epoch time for comparison
            expiry_epoch=$(date -d "$expiry_date" +%s 2>/dev/null || echo "0")
            current_epoch=$(date +%s)

            if [ "$expiry_epoch" -gt "$current_epoch" ]; then
              echo "âœ… security.txt is not expired (expires: $expiry_date)"
            else
              echo "âš ï¸ security.txt may be expired or date format issue"
            fi
          else
            echo "âš ï¸ Missing expiry date"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Playwright
        run: |
          npm install -D @playwright/test
          npx playwright install chromium

      - name: Test demo login flow
        run: |
          cat > test-demo.js << 'EOF'
          const { chromium } = require('playwright');

          (async () => {
            const browser = await chromium.launch();
            const page = await browser.newPage();

            try {
              console.log('ðŸ” Testing demo login flow...');

              // Navigate to demo site
              await page.goto('https://demo.securebase.io/', { timeout: 10000 });
              console.log('âœ… Demo site loaded');

              // Check for login form
              const loginForm = await page.locator('input[type="text"], input[type="email"]').first();
              if (loginForm) {
                console.log('âœ… Login form found');
              } else {
                console.log('âš ï¸ Login form not found');
              }

              // Take screenshot
              await page.screenshot({ path: 'demo-homepage.png' });
              console.log('ðŸ“¸ Screenshot saved');

            } catch (error) {
              console.error('âŒ Test failed:', error.message);
              process.exit(1);
            } finally {
              await browser.close();
            }
          })();
          EOF

          node test-demo.js

      - name: Run Lighthouse audit (optional)
        uses: treosh/lighthouse-ci-action@v11
        continue-on-error: true
        with:
          urls: 'https://demo.securebase.io/'
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Create summary
        if: always()
        run: |
          echo "## ðŸŽ¯ Demo Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** demo.securebase.io" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checks Performed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Site accessibility" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security headers" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… security.txt file" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Demo login flow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "For details, see the workflow run logs." >> $GITHUB_STEP_SUMMARY

      - name: Upload screenshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: demo-screenshots
          path: demo-homepage.png
          retention-days: 7

  notify-on-failure:
    name: Notify on validation failure
    runs-on: ubuntu-latest
    needs: validate-demo
    if: failure() && github.event_name == 'schedule'

    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ Demo Environment Validation Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `## Demo Validation Failure\n\n` +
              `The automated validation of demo.securebase.io has failed.\n\n` +
              `**Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\n` +
              `**Timestamp:** ${new Date().toISOString()}\n\n` +
              `Please investigate and resolve the issue.`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['demo', 'bug', 'urgent']
            });
