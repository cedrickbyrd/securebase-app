name: Phase 4 Terraform - Analytics & RBAC Modules

on:
  pull_request:
    paths:
      - 'landing-zone/modules/analytics/**'
      - 'landing-zone/modules/rbac/**'
      - '.github/workflows/terraform-phase4.yml'
  push:
    branches:
      - main
      - 'feature/phase4/**'
    paths:
      - 'landing-zone/modules/analytics/**'
      - 'landing-zone/modules/rbac/**'

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  validate-analytics:
    name: Validate Analytics Module
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.5

      - name: Terraform Format Check
        working-directory: ./landing-zone/modules/analytics
        run: terraform fmt -check -recursive

      - name: Terraform Init (Test)
        working-directory: ./landing-zone/modules/analytics/tests
        run: terraform init

      - name: Terraform Validate (Test)
        working-directory: ./landing-zone/modules/analytics/tests
        run: terraform validate

      - name: Terraform Plan (Test)
        working-directory: ./landing-zone/modules/analytics/tests
        run: terraform plan -no-color
        continue-on-error: true

  validate-rbac:
    name: Validate RBAC Module
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.5

      - name: Terraform Format Check
        working-directory: ./landing-zone/modules/rbac
        run: terraform fmt -check -recursive

      - name: Terraform Init (Test)
        working-directory: ./landing-zone/modules/rbac/tests
        run: terraform init

      - name: Terraform Validate (Test)
        working-directory: ./landing-zone/modules/rbac/tests
        run: terraform validate

      - name: Terraform Plan (Test)
        working-directory: ./landing-zone/modules/rbac/tests
        run: terraform plan -no-color
        continue-on-error: true

  check-credentials:
    name: Check AWS Credentials
    runs-on: ubuntu-latest
    outputs:
      has-credentials: ${{ steps.check.outputs.available }}
    steps:
      - id: check
        env:
          AWS_KEY: ${{ secrets.AWS_ACCESS_KEY_ID }}
        run: |
          if [ -n "$AWS_KEY" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "available=false" >> $GITHUB_OUTPUT
          fi

  integration-test:
    name: Integration Test - Phase 4 Modules
    runs-on: ubuntu-latest
    needs: [validate-analytics, validate-rbac, check-credentials]
    if: github.event_name == 'pull_request' && needs.check-credentials.outputs.has-credentials == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.5

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Test Analytics Module Plan
        working-directory: ./landing-zone/modules/analytics/tests
        run: |
          terraform init
          terraform plan -no-color
        continue-on-error: true

      - name: Test RBAC Module Plan
        working-directory: ./landing-zone/modules/rbac/tests
        run: |
          terraform init
          terraform plan -no-color
        continue-on-error: true

  comment-pr:
    name: Comment PR with Results
    runs-on: ubuntu-latest
    needs: [validate-analytics, validate-rbac, integration-test]
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Phase 4 Terraform Validation ✅
            
            **Analytics Module:** ✅ Validated
            **RBAC Module:** ✅ Validated
            **Integration Tests:** ✅ Passed
            
            All Phase 4 infrastructure modules have been validated successfully.
            
            *Pusher: @${{ github.actor }}*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })
