name: Deploy Phase 4 Analytics

on:
  push:
    branches:
      - main
    paths:
      - 'phase2-backend/functions/analytics_*.py'
      - 'landing-zone/modules/analytics/**'
      - 'scripts/deploy_analytics.sh'
      - '.github/workflows/deploy-analytics.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - production

env:
  AWS_REGION: us-east-1
  PYTHON_VERSION: '3.11'
  TERRAFORM_VERSION: '1.6.0'

jobs:
  # Job 1: Pre-deployment validation
  validate:
    name: Validate Code & Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest boto3 moto
      
      - name: Run Python linting
        run: |
          pip install pylint
          pylint phase2-backend/functions/analytics_*.py || true
      
      - name: Run unit tests
        run: |
          pytest tests/integration/test_analytics_integration.py -v --tb=short
      
      - name: Validate Terraform syntax
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Terraform Format Check
        run: |
          cd landing-zone/modules/analytics
          terraform fmt -check -recursive
      
      - name: Terraform Validate
        run: |
          cd landing-zone/modules/analytics
          terraform init -backend=false
          terraform validate

  # Job 2: Deploy to Staging
  deploy-staging:
    name: Deploy to Staging
    needs: validate
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging-api.securebase.example.com/analytics
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Deploy Analytics to Staging
        env:
          CI: true
        run: |
          chmod +x scripts/deploy_analytics.sh
          ./scripts/deploy_analytics.sh staging ${{ env.AWS_REGION }}
      
      - name: Run Integration Tests
        env:
          API_BASE_URL: ${{ secrets.STAGING_API_URL }}
          TEST_API_KEY: ${{ secrets.STAGING_API_KEY }}
          TEST_CUSTOMER_ID: ${{ secrets.STAGING_CUSTOMER_ID }}
        run: |
          pip install pytest requests
          pytest tests/integration/test_analytics_integration.py -v
      
      - name: Run Smoke Tests
        env:
          API_BASE_URL: ${{ secrets.STAGING_API_URL }}
          TEST_API_KEY: ${{ secrets.STAGING_API_KEY }}
        run: |
          # Test analytics endpoints are accessible
          curl -f -H "X-API-Key: $TEST_API_KEY" "$API_BASE_URL/analytics/usage?period=7d" || exit 1
          echo "âœ“ Smoke tests passed"
      
      - name: Post deployment summary
        if: always()
        run: |
          echo "## Staging Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: staging" >> $GITHUB_STEP_SUMMARY
          echo "- Region: ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deployed at: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Lambda Functions" >> $GITHUB_STEP_SUMMARY
          echo "- analytics-aggregator" >> $GITHUB_STEP_SUMMARY
          echo "- analytics-reporter" >> $GITHUB_STEP_SUMMARY
          echo "- analytics-query" >> $GITHUB_STEP_SUMMARY
          echo "- report-engine" >> $GITHUB_STEP_SUMMARY

  # Job 3: E2E Tests in Staging
  e2e-tests:
    name: E2E Tests (Staging)
    needs: deploy-staging
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.environment == 'staging'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install test dependencies
        run: |
          pip install pytest requests
      
      - name: Run E2E Tests
        env:
          RUN_E2E_TESTS: '1'
          API_BASE_URL: ${{ secrets.STAGING_API_URL }}
          TEST_API_KEY: ${{ secrets.STAGING_API_KEY }}
          TEST_CUSTOMER_ID: ${{ secrets.STAGING_CUSTOMER_ID }}
        run: |
          pytest tests/e2e/test_analytics_e2e.py -v --tb=short -m "not slow"
      
      - name: Run Load Tests
        env:
          RUN_E2E_TESTS: '1'
          API_BASE_URL: ${{ secrets.STAGING_API_URL }}
          TEST_API_KEY: ${{ secrets.STAGING_API_KEY }}
          TEST_CUSTOMER_ID: ${{ secrets.STAGING_CUSTOMER_ID }}
        run: |
          pytest tests/e2e/test_analytics_e2e.py::TestPerformance::test_load_test_100_concurrent_requests -v

  # Job 4: Security Scan
  security-scan:
    name: Security Scan
    needs: deploy-staging
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.environment == 'staging'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          languages: python
      
      - name: Security vulnerability scan
        run: |
          pip install safety bandit
          safety check --json || true
          bandit -r phase2-backend/functions/analytics_*.py -f json || true

  # Job 5: Deploy to Production (manual approval required)
  deploy-production:
    name: Deploy to Production
    needs: [deploy-staging, e2e-tests, security-scan]
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://api.securebase.example.com/analytics
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.PROD_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.PROD_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Deploy Analytics to Production
        env:
          CI: true
        run: |
          chmod +x scripts/deploy_analytics.sh
          ./scripts/deploy_analytics.sh production ${{ env.AWS_REGION }}
      
      - name: Production Smoke Tests
        env:
          API_BASE_URL: ${{ secrets.PROD_API_URL }}
          TEST_API_KEY: ${{ secrets.PROD_API_KEY }}
        run: |
          curl -f -H "X-API-Key: $TEST_API_KEY" "$API_BASE_URL/analytics/usage?period=7d" || exit 1
          echo "âœ“ Production smoke tests passed"
      
      - name: Notify deployment success
        if: success()
        run: |
          echo "ðŸŽ‰ Phase 4 Analytics deployed to production successfully!"
          echo "Monitoring: https://console.aws.amazon.com/cloudwatch"
      
      - name: Rollback on failure
        if: failure()
        run: |
          echo "âš ï¸ Production deployment failed. Initiating rollback..."
          # Rollback logic would go here
          exit 1

  # Job 6: Monitor Deployment Health (48 hours)
  monitor-health:
    name: Monitor Deployment Health
    needs: deploy-production
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'production'
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.PROD_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.PROD_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Check CloudWatch Alarms
        run: |
          # Check for any alarms in ALARM state
          ALARMS=$(aws cloudwatch describe-alarms \
            --alarm-name-prefix "securebase-production-analytics" \
            --state-value ALARM \
            --query 'MetricAlarms[*].AlarmName' \
            --output text)
          
          if [ -n "$ALARMS" ]; then
            echo "âš ï¸ Active alarms detected: $ALARMS"
            exit 1
          else
            echo "âœ“ No active alarms"
          fi
      
      - name: Check Lambda Error Rates
        run: |
          # Query last hour error rate for all analytics functions
          for FUNCTION in analytics-aggregator analytics-reporter analytics-query; do
            ERRORS=$(aws cloudwatch get-metric-statistics \
              --namespace AWS/Lambda \
              --metric-name Errors \
              --dimensions Name=FunctionName,Value=securebase-production-$FUNCTION \
              --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%S) \
              --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
              --period 3600 \
              --statistics Sum \
              --query 'Datapoints[0].Sum' \
              --output text)
            
            echo "Function: $FUNCTION, Errors (1h): ${ERRORS:-0}"
          done

# Workflow summary
  workflow-summary:
    name: Workflow Summary
    needs: [validate, deploy-staging, e2e-tests, security-scan]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## Phase 4 Analytics Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ${{ needs.validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Staging | ${{ needs.deploy-staging.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Workflow completed at: $(date)" >> $GITHUB_STEP_SUMMARY
