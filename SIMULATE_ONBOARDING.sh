#!/bin/bash
# SecureBase PaaS - Customer Onboarding Simulation
# This simulates onboarding ACME Finance Inc (Fintech, SOC2)

set -e

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ§ª SECUREBASE PAAS - CUSTOMER ONBOARDING SIMULATION"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Test Customer:"
echo "  Company: ACME Finance Inc"
echo "  Tier: Fintech"
echo "  Framework: SOC2 Type II"
echo "  AWS Account: 222233334444"
echo "  Contact: john@acmefinance.com"
echo "  Expected Cost: $8,000/month base + usage"
echo ""

# Step 1: Verify customer config is in place
echo "Step 1: Verify Customer Configuration"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

cd "$(dirname "$0")/landing-zone/environments/dev" || exit 1

if grep -q "acme-finance" client.auto.tfvars; then
  echo "  âœ… ACME Finance found in client.auto.tfvars"
  echo ""
  echo "  Configuration:"
  grep -A 10 '"acme-finance"' client.auto.tfvars | sed 's/^/    /'
else
  echo "  âŒ ACME Finance NOT found in client.auto.tfvars"
  exit 1
fi

echo ""

# Step 2: Initialize Terraform (if needed)
echo "Step 2: Terraform Initialization"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
if [ ! -d ".terraform" ]; then
  echo "  Initializing Terraform..."
  terraform init > /dev/null 2>&1
  echo "  âœ… Terraform initialized"
else
  echo "  âœ… Terraform already initialized"
fi
echo ""

# Step 3: Validate configuration
echo "Step 3: Validating Configuration"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
terraform validate > /dev/null 2>&1 && echo "  âœ… Configuration valid" || echo "  âŒ Configuration invalid"
echo ""

# Step 4: Generate plan
echo "Step 4: Generating Terraform Plan"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "  Analyzing what will be created..."
terraform plan -out=tfplan.test > /dev/null 2>&1
echo "  âœ… Plan generated"
echo ""

# Step 5: Show what will be created
echo "Step 5: Deployment Plan Summary"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "  What Terraform will create:"
echo ""
echo "  ğŸ“ Organizational Unit:"
echo "     â€¢ Name: Customers-Fintech"
echo "     â€¢ Purpose: Houses all fintech-tier customer accounts"
echo "     â€¢ Guardrails: SOC2 compliance SCPs"
echo ""
echo "  ğŸ¢ Customer AWS Account:"
echo "     â€¢ Name: acme"
echo "     â€¢ Email: acme@731184206915.aws-internal"
echo "     â€¢ Parent OU: Customers-Fintech"
echo "     â€¢ Tags:"
echo "       - Customer: ACME Finance Inc"
echo "       - Tier: Fintech"
echo "       - Framework: SOC2"
echo "       - ContactEmail: john@acmefinance.com"
echo ""
echo "  ğŸ” Security Policies (auto-attached):"
echo "     â€¢ RestrictRootUser - Prevent root account usage"
echo "     â€¢ BlockIAMUsers - Enforce IAM Identity Center only"
echo "     â€¢ RestrictRegions - Limit to us-east-1, us-west-2"
echo "     â€¢ EnableCloudTrail - Centralized logging"
echo "     â€¢ SOC2Framework - SOC2-specific compliance controls"
echo ""
echo "  ğŸ“Š Compliance Monitoring:"
echo "     â€¢ CloudTrail enabled (logs to SecureBase account)"
echo "     â€¢ AWS Config recorder enabled"
echo "     â€¢ GuardDuty enabled (threat detection)"
echo "     â€¢ Security Hub enabled (compliance aggregation)"
echo ""
echo "  ğŸ“ˆ Billing:"
echo "     â€¢ Monthly base: $8,000"
echo "     â€¢ API calls: $0.0003 per call (after 50k/month free)"
echo "     â€¢ Compliance scans: $35 each"
echo ""

# Step 6: Show estimated timeline
echo "Step 6: Deployment Timeline"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "  What happens when you run 'terraform apply':"
echo ""
echo "  â±ï¸  0-2 min:     OU creation (Customers-Fintech)"
echo "  â±ï¸  2-5 min:     AWS Account creation"
echo "  â±ï¸  5-7 min:     Policy attachments"
echo "  â±ï¸  7-8 min:     Tagging & finalization"
echo ""
echo "  Total estimated time: 7-10 minutes"
echo ""

# Step 7: Show outputs
echo "Step 7: Expected Outputs"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "  After deployment, you'll see:"
echo ""
echo "  client_account_ids = {"
echo '    "acme-finance" = "222233334444"'
echo "  }"
echo ""
echo "  customer_ou_ids = {"
echo "    fintech = \"ou-xxxx-xxxx\"  (the newly created OU)"
echo "  }"
echo ""
echo "  central_log_bucket = \"securebase-audit-logs-production\""
echo ""

# Step 8: Onboarding tasks
echo "Step 8: Post-Deployment Onboarding Tasks"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "  For ACME Finance team (john@acmefinance.com):"
echo ""
echo "  1. âœ… Account Created"
echo "     AWS Account ID: 222233334444"
echo "     Available in: Customers-Fintech OU"
echo ""
echo "  2. ğŸ” Next: Set up IAM Identity Center"
echo "     â€¢ Create user account in SecureBase SSO"
echo "     â€¢ Assign to ACME Finance account"
echo "     â€¢ Send SSO login link"
echo "     â€¢ Est. time: 5 minutes"
echo ""
echo "  3. ğŸ“‹ Next: Configure AWS Account"
echo "     â€¢ Verify CloudTrail is logging"
echo "     â€¢ Set up cost allocation tags"
echo "     â€¢ Enable CloudWatch dashboards"
echo "     â€¢ Est. time: 15 minutes"
echo ""
echo "  4. ğŸ” Next: Baseline Compliance Scan"
echo "     â€¢ Run initial SOC2 assessment"
echo "     â€¢ Generate baseline report"
echo "     â€¢ Document compliance status"
echo "     â€¢ Est. time: 5 minutes"
echo ""
echo "  5. ğŸ’³ Next: Billing Setup"
echo "     â€¢ Verify billing contact"
echo "     â€¢ Set up invoice email"
echo "     â€¢ Configure payment method"
echo "     â€¢ Est. time: 5 minutes"
echo ""
echo "  6. ğŸ“ Next: Customer Kickoff Call"
echo "     â€¢ Confirm account access"
echo "     â€¢ Walkthrough dashboard"
echo "     â€¢ Answer questions"
echo "     â€¢ Est. time: 30 minutes"
echo ""
echo "  Total onboarding time: ~1 hour"
echo ""

# Step 9: Potential issues & solutions
echo "Step 9: Potential Issues & Solutions"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "  âš ï¸  Issue: Customer's AWS Account ID already in use"
echo "     Solution: Verify account ID is unique; retry if copy error"
echo ""
echo "  âš ï¸  Issue: Email format invalid (no @domain)"
echo "     Solution: Email must follow AWS account creation rules"
echo ""
echo "  âš ï¸  Issue: Organization limits reached"
echo "     Solution: Request AWS service limit increase"
echo ""
echo "  âš ï¸  Issue: CloudTrail not logging"
echo "     Solution: Check S3 bucket permissions; verify trail enabled"
echo ""
echo "  âš ï¸  Issue: SOC2 policy attachment fails"
echo "     Solution: Verify OU exists; check policy syntax"
echo ""

# Step 10: Cleanup
echo "Step 10: Cleanup (Optional)"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "  To test without deploying, just validate:"
echo "    terraform validate"
echo ""
echo "  To see detailed plan without deploying:"
echo "    terraform show tfplan.test"
echo ""
echo "  To actually deploy this test customer:"
echo "    terraform apply tfplan.test"
echo ""
echo "  To remove test customer later:"
echo "    1. Remove 'acme-finance' from client.auto.tfvars"
echo "    2. terraform plan"
echo "    3. terraform apply"
echo ""

# Clean up
rm -f tfplan.test

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "âœ… ONBOARDING SIMULATION COMPLETE"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Summary:"
echo "  Customer: ACME Finance Inc (Fintech)"
echo "  Status: Ready for deployment"
echo "  Expected deployment time: 7-10 minutes"
echo "  Expected total onboarding: ~1 hour"
echo "  Monthly revenue: $8,000 + usage"
echo ""
echo "Next steps:"
echo "  1. Review the plan above for any issues"
echo "  2. If ready, run: terraform apply"
echo "  3. Track deployment in AWS Organizations console"
echo "  4. Complete post-deployment onboarding tasks"
echo ""
